---
title: "Data Processing"
format: html
toc: TRUE
execute: 
  warning: false
  message: false
---

In this notebook, we will write several functions that will allow users to query the Census API with their own inputs, and then explore the data through summary statistics. 

### Import necessary libraries

```{r}
library(tidyverse)
library(httr)
library(jsonlite)
```

### Helper function to turn result of API call into a tibble

```{r}
to_tibble <- function(request) {
  data <- fromJSON(rawToChar(request$content))
  data <- as_tibble(data[-1, ])
  
  # Assign column names
  col_names <- data[1, ]
  colnames(data) <- col_names 
  
  # Return tibble
  return(data)
}
```

### Function to query the API with user input

```{r}
query_pums <- function(
    year = 2022,
    num_vars = c('AGEP', 'PWGTP'),
    cat_vars = 'SEX',
    geo_level = 'All',
    subset = NULL
) {
  
  # Stop if year is not between 2010 and 2022
  if (!year %in% 2010:2022)
    stop('Year must be between 2010 and 2022.')
  
  # Define valid numeric variables
  valid_num <- c('AGEP', 'PWGTP', 'GASP', 'GRPIP', 'JWAP', 'JWDP', 'JWMNP')
  
  # Stop if num_vars input is valid
  if (!all(num_vars %in% valid_num))
    stop('Invalid input for numeric variables.')
  # Stop if PWGTP is not returned
  if (!'PWGTP' %in% num_vars)
    stop('PWGTP must be returned.')
  # Stop if less than 2 numeric variables are returned
  if (length(num_vars) < 2)
    stop('At least one numeric variable aside from PWGTP must be returned.')
  
  # Define valid categorical variables
  valid_cat <- c('FER', 'HHL', 'HISPEED', 'JWTRNS', 'SCH', 'SCHL', 'SEX')
  
  # Stop if cat_vars input is invalid
  if (!all(cat_vars %in% valid_cat))
    stop('Invalid input for categorical variables.')
  # Stop if no categorical variables are returned
  if (length(cat_vars) < 1)
    stop('At least one categorical variable must be returned.')
  
  # Define valid inputs for geography
  valid_geo <- c('All', 'Region', 'Division', 'State')
  
  # Stop if geo_level input is not valid
  if (!geo_level %in% valid_geo)
    stop('Invalid input for geography level.')
  
  # Base URL
  url <- 'api.census.gov/data'
  # Data set we want to query
  dataset <- 'acs/acs1/pums'
  # Variables to query
  vars <- c(num_vars, cat_vars)
  
  # Build URL with user inputs
  api_url <- paste0(
    url, "/", year, "/", dataset,
    "?get=", paste(vars, collapse = ",")
  )
  
  # Geography level subsetting
  geo_map <- c(
    Region   = "region:*",
    Division = "division:*",
    State    = "state:*"
  )
  
  # allow users to specify subsets of geography level
  if (!is.null(subset)) {
    if (geo_level == 'State') {
      api_url <- paste0(api_url, '&for=state:', paste(subset, collapse = ','))
    }
    if (geo_level == 'Region') {
      api_url <- paste0(api_url, '&for=region:', paste(subset, collapse = ','))
    }
    if (geo_level == 'Division') {
      api_url <- paste0(api_url, '&for=division:', paste(subset, collapse = ','))
    }
  } else if (geo_level != 'All') {
    api_url <- paste0(api_url, '&for=', geo_map[[geo_level]])
  }
  
  # Query the API
  request <- GET(api_url)
  
  # Call helper function to turn query results into tibble
  data <- to_tibble(request)
  
  #TO BE ADDED: ensure data types are correct
  
  # For summary function
  class(data) <- c("census", class(data))
  
  return(data)
}
```

#### Test query_pums() function

Without sub-setting the geography level, this function is time consuming to run.

```{r}
query_pums(
  year = 2022,
  num_vars = c('AGEP', 'PWGTP', 'GRPIP'),
  cat_vars = c('SEX', 'HISPEED'),
  geo_level = 'State',
  subset='06'
)
```

Add function to specify multiple years of survey data & generic function to summarize
